var livemail=new function(){var i=new Array();var l=new Array();var e=new Array();var H=new Array();var J=0;var h;var d=false;var f;var u={checkTime:120000,scriptDirectory:"/mail/scripts/",cssDirectory:"/mail/css/",uid:1,wid:0};this.init=F;function o(L,M){$.extend(u,M)}function F(){$(document).on("click","#livemail .livemessages .livemessage",G).on("click",".livemail",k).on("showlivemail",k).on("livemail",s).on("livemailinit",o).on("messages-loaded",B);$.get(u.cssDirectory+"style.css",function(L){$("head").append('<style type="text/css">'+L+"</style>");$("body").append('<div id="livemail"><div class="liveheader"><div class="back"></div><span class="title">Messages</span><div class="close"></div></div><div class="layers"><form><textarea placeholder="Type a question here..."></textarea><Button>Send</Button></form><div class="livemessages"></div><div class="read"><div class="thread"></div></div></div><div class="loader"></div></div>');$("#livemail .close").click(r);$("#livemail .back").click(E);$("#livemail form Button").click(z);$("#livemail form").submit(function(){return false})});$(document).trigger("livemailloaded")}function y(){var L="website_id="+u.wid;p(L,u.scriptDirectory+"request.check_mail_status.php",g)}function g(L){l=new Array();c(L,l,K)}function K(){if(l.length>0){$(document).trigger("livemail")}}function s(M){var L="website_id="+u.wid;clearInterval(h);t();j();p(L,u.scriptDirectory+"request.mail.php",D)}function D(L){i=new Array();c(L,i,I)}function I(){var L=false;$.each(i,function(M,N){x(N.message,N.id,N.date_created,N.from_user_id==u.uid?"You":N.name)});b();$(document).trigger("messages-loaded");h=setInterval(y,u.checkTime)}function B(L){$.each(i,function(M,N){if((N.status=="0")&&((!d)||(d&&N.reply_id==J))){a(N.id);showingMessage=true;k(L,true);return false}});$("#livemail .timeago").timeago()}function G(L){a($(this).attr("data-id"))}function a(M){var L="website_id="+u.wid+"&message_id="+M+"&action=thread";J=parseInt(M,10);A();t();p(L,u.scriptDirectory+"request.mail.php",C)}function C(L){e=new Array();c(L,e,m)}function m(){$.each(e,function(L,M){v(M)});b();$("#livemail .timeago").timeago();q()}function v(L){w(L);n(L.id)}function x(N,O,M,L){$("#livemail .livemessages").append('<div class="livemessage" data-id="'+O+'"><div class="name">'+L+"</div><span>"+N+'</span><div class="livedate timeago" title="'+M+'">'+M+"</div></div>")}function w(O){var L=O.from_user_id=="0"?"admin":"";var M=O.from_user_id==u.uid?"You":O.name;var N=O.message;N=N.replace(/\r\n|\r|\n/g,"<br>");$("#livemail .thread").prepend('<div class="livemessage '+L+'" data-id="'+O.id+'"><div class="pic"></div><div class="name">'+M+"</div><span>"+N+'</span><div class="livedate timeago" title="'+O.date_created+'">'+O.date_created+"</div></div>")}function n(L){var M="website_id="+u.wid+"&action=update&id="+L;p(M,u.scriptDirectory+"update.mail.php")}function z(){var M=$("#livemail form textarea").val();if(M!=""){var L="website_id="+u.wid+"&action=reply&id="+J+"&message="+M;t();p(L,u.scriptDirectory+"update.mail.php",s);$("#livemail form textarea").val("")}}function k(M,L){if(!L){s()}$("#livemail").addClass("show");d=true;return false}function r(){$("#livemail").removeClass("show");d=false}function E(){$("#livemail form textarea").attr("placeholder","Type a question here...");$("#livemail").removeClass("show-message");J=0}function q(){$("#livemail form textarea").attr("placeholder","Type your reply here...");$("#livemail").addClass("show-message")}function j(){$("#livemail .livemessages").empty()}function A(){$("#livemail .thread").empty()}function t(){$("#livemail").addClass("loading")}function b(){$("#livemail").removeClass("loading")}function p(O,N,L,M,P){if(typeof sess_id=="undefined"){sess_id=""}$.ajax({type:"POST",url:N+"?id="+sess_id,data:O,dataType:"text",error:function(Q,S,R){},success:function(Q){var S=$.parseXML(Q);var R=$(S);if(L){L(R,P)}if(M){$(M).dialog("close")}}});return false}function c(M,L,O,N){if(M){$(M).find("row").each(function(){var P=0;var R="";var S=$(this);var Q=new Object();var T=S.children()[P].nodeName;while(T){Q[T]=S.find(T).text();if(S.children()[P]){T=S.children()[P].nodeName}else{T=false}P++}L.push(Q)})}if(O){if(N){O(N)}else{O()}}}};$(function(){livemail.init()});